<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Silverlake IAA Vehicle Portal</title>
    <link rel="icon" href="{{ url_for('static', filename='SLK Logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
      :root {
        --sidebar-expanded: 260px;
        --sidebar-collapsed: calc(var(--sidebar-expanded) * 0.3);
        --sidebar-bg: #5c9c13;
      }
      body {
        margin: 0;
        background: url("{{ url_for('static', filename='background.jpg') }}") no-repeat center center fixed;
        background-size: cover;
        font-family: 'Montserrat', sans-serif;
        color: black;
      }
      h1, h2, label {
        color: #5c9c13;
      }
      .page-wrapper {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-collapsed);
        background-color: var(--sidebar-bg);
        color: #fff;
        position: fixed;
        inset: 0 auto 0 0;
        overflow: hidden;
        transition: width 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 12px;
        z-index: 1000;
      }
      .sidebar:hover {
        width: var(--sidebar-expanded);
      }
      .sidebar .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 10px;
      }
      .sidebar .logo-collapsed {
        height: 34px;
        opacity: 1;
        transition: opacity 0.2s ease;
      }
      .sidebar .logo-expanded {
        height: 34px;
        opacity: 0;
        transform: translateX(-6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .sidebar:hover .logo-collapsed {
        opacity: 0;
      }
      .sidebar:hover .logo-expanded {
        opacity: 1;
        transform: translateX(0);
      }
      .sidebar .brand-text {
        font-weight: 700;
        font-size: 1.05rem;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .sidebar:hover .brand-text {
        opacity: 1;
      }
      .sidebar .nav-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .sidebar .nav-link {
        color: #fff;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        text-decoration: none;
        transition: background-color 0.2s ease, color 0.2s ease;
        font-size: 0.95rem;
      }
      .sidebar .nav-link i {
        width: 20px;
        text-align: center;
        font-size: 1.15rem;
      }
      .sidebar .nav-link .link-text {
        white-space: nowrap;
        opacity: 0;
        transform: translateX(-6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .sidebar:hover .nav-link .link-text {
        opacity: 1;
        transform: translateX(0);
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background-color: rgba(255, 255, 255, 0.16);
        color: #fff;
      }
      .sidebar-footer {
        margin-top: auto;
      }
      .content {
        flex: 1;
        margin-left: var(--sidebar-collapsed);
        transition: margin-left 0.3s ease;
      }
      .sidebar:hover ~ .content {
        margin-left: var(--sidebar-expanded);
      }
      .content-inner {
        padding: 24px 12px;
      }
      .portal-container {
        width: 90%;
        max-width: 1720px;
        margin: 0 auto;
        padding-left: 8px;
        padding-right: 8px;
      }
      .logo {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
      }
      .logo img {
        width: 150px;
        max-width: 50%;
        height: auto;
      }
      .summary-card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }

      .mode-toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin-left: 0;
      }
      .mode-toggle-row {
        margin-top: 20px;
      }
      .mode-toggle-label {
        color: #5c9c13;
        font-weight: 700;
        margin-bottom: 0;
      }
      .mode-toggle-pill {
        display: inline-flex;
        align-items: center;
        background: #d8f1bb;
        border: 2px solid #5c9c13;
        border-radius: 999px;
        padding: 3px;
      }
      .mode-toggle-option {
        min-width: 132px;
        text-align: center;
        text-decoration: none;
        color: #143800;
        font-weight: 700;
        border-radius: 999px;
        padding: 8px 16px;
        transition: all 0.2s ease;
      }
      .mode-toggle-option:hover {
        color: #143800;
        background: rgba(92, 156, 19, 0.12);
      }
      .mode-toggle-option.active {
        background: #5c9c13;
        color: #fff;
      }

      .has-comments-btn {
        border: 0;
        background: none;
        padding: 0;
        text-decoration: underline;
        font-weight: 700;
      }
      .has-comments-btn.has-comments-unread {
        color: #b42318;
      }
      .has-comments-btn.has-comments-read {
        color: #067647;
      }
      .has-comments-btn:hover {
        opacity: 0.85;
      }
      .note-row-btn {
        border: 0;
        width: 100%;
        text-align: left;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
      }
      .note-row-btn:hover {
        background: #e9ecef;
      }
      .vehicle-note-subject-unread {
        font-weight: 700;
      }
      
      .vehicle-details-table thead th {
        position: sticky;
        background-color: #fff;
        z-index: 2;
      }
      .vehicle-details-table thead tr:first-child th {
        top: 0;
        z-index: 4;
      }
      .vehicle-details-table thead tr.filter-row th {
        top: var(--vehicle-details-header-row-height, 0px);
        z-index: 3;
        padding-top: 6px;
        padding-bottom: 6px;
      }
      .vehicle-details-filter {
        width: 100%;
        min-width: 110px;
        font-size: 0.8rem;
      }
      .vehicle-search-controls {
        min-width: 320px;
      }
      .vehicle-table-frame {
        width: 100%;
        max-width: 100%;
        max-height: 60vh;
        overflow-x: auto;
        overflow-y: auto;
      }
      .vehicle-table-frame .vehicle-details-table {
        width: max-content;
        min-width: 100%;
      }
      @media (max-width: 768px) {
        :root {
          --sidebar-expanded: 220px;
        }
        .vehicle-search-controls {
        width: 100%;
        min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <nav class="sidebar">
        <div class="brand">
          <img src="{{ url_for('static', filename='SLK Logo.png') }}" alt="Silverlake Collapsed Logo" class="logo-collapsed">
          <img src="{{ url_for('static', filename='logo-slg-strip.svg') }}" alt="Silverlake Logo" class="logo-expanded">
        </div>
        <div class="nav-section">
          <a href="{{ url_for('vehicle_stats') }}" class="nav-link{% if active_page == 'vehicle_stats' %} active{% endif %}">
            <i class="fas fa-car-side"></i>
            <span class="link-text">Vehicle Stats</span>
          </a>
          {% if current_user_is_admin %}
            <a href="{{ url_for('manage_users') }}" class="nav-link{% if active_page == 'user_management' %} active{% endif %}">
              <i class="fas fa-users-gear"></i>
              <span class="link-text">User Management</span>
            </a>
          {% endif %}
        </div>
        <div class="sidebar-footer">
          <a href="{{ url_for('logout') }}" class="nav-link">
            <i class="fas fa-arrow-right-from-bracket"></i>
            <span class="link-text">Logout ({{ current_user }})</span>
          </a>
        </div>
      </nav>
      <div class="content">
        <div class="content-inner">
          <div class="container-fluid portal-container">
            <div class="logo">
              <img src="{{ url_for('static', filename='logo-slg-strip.svg') }}" alt="Silverlake Logo">
            </div>

            <h1 class="mb-4 text-center">Silverlake IAA Vehicle Portal</h1>

            {% if error_message %}
              <div class="alert alert-danger" role="alert">{{ error_message }}</div>
            {% endif %}

            <div class="summary-card">
              <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
                <div>
                  <div class="d-flex flex-wrap align-items-center gap-2">
                    <a href="{{ url_for('vehicle_stats', filter='today', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-success date-link">Today</a>
                    <a href="{{ url_for('vehicle_stats', filter='yesterday', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-success date-link">Yesterday</a>
                    <a href="{{ url_for('vehicle_stats', filter='this_week', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-success date-link">This Week</a>
                    <a href="{{ url_for('vehicle_stats', filter='last_week', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-success date-link">Last Week</a>
                    <a href="{{ url_for('vehicle_stats', filter='this_month', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-success date-link">This Month</a>
                    <a href="{{ url_for('vehicle_stats', filter='last_month', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-success date-link">Last Month</a>
                    <form method="get" class="d-inline">
                      <input type="hidden" name="filter" value="custom">
                      <input type="hidden" name="group" value="{{ group_mode }}">
                      <input type="hidden" name="date_field" value="{{ date_field }}">
                      <input type="date" name="start_date" id="customStartDate" required>
                      <input type="date" name="end_date" id="customEndDate" required>
                      {% if live_enabled %}
                        <input type="hidden" name="live" value="1">
                      {% endif %}
                      <button type="submit" class="btn btn-sm btn-success">Custom</button>
                    </form>
                    {% if group_mode == 'branch' %}
                      <a href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group='status', date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-outline-primary">Group by Status</a>
                    {% else %}
                      <a href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group='branch', date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-outline-primary">Group by Branch</a>
                    {% endif %}
                  </div>

                  <div class="mode-toggle mode-toggle-row">
                    <span class="mode-toggle-label">Mode</span>
                    <div class="mode-toggle-pill" role="group" aria-label="Date query mode">
                      <a
                        href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group=group_mode, date_field='recovered', live=1 if live_enabled else None) }}"
                        class="mode-toggle-option date-field-link{% if date_field == 'recovered' %} active{% endif %}"
                      >
                        Date Recovered
                      </a>
                      <a
                        href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group=group_mode, date_field='entered', live=1 if live_enabled else None) }}"
                        class="mode-toggle-option date-field-link{% if date_field == 'entered' %} active{% endif %}"
                      >
                        Date Entered
                      </a>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex flex-column align-items-start gap-2 ms-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="liveToggle" {% if live_enabled %}checked{% endif %}>
                    <label class="form-check-label text-success" for="liveToggle">Live</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input comment-read-scope-toggle" type="checkbox" role="switch" id="commentReadScopeGlobalMain" data-comment-scope-toggle>
                    <label class="form-check-label" for="commentReadScopeGlobalMain">Use global read status (shared across all users top)</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4 mb-4">
              <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                  <h5 class="text-success mb-0" id="dateRangeLabel">Showing: {{ date_range_label }}</h5>
                  <span class="badge bg-success" id="dateFieldLabel">Query Date: {{ date_field_label }}</span>
                </div>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>{{ entity_label }}</th>
                      <th class="text-end">Vehicles</th>
                    </tr>
                  </thead>
                  <tbody id="companyTableBody">
                    {% for row in rows %}
                    <tr>
                      <td>{{ row[0] }}</td>
                      <td class="text-end">{{ '{:,.0f}'.format(row[1]) }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr class="fw-bold">
                      <td>Total</td>
                      <td class="text-end" id="totalSumCell">{{ '{:,.0f}'.format(sum_total) }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              <div class="col-lg-6">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="card-title mb-0" id="chartTitle">{{ chart_title_base }} </h5>
                      <div class="d-flex gap-2">
                        <button id="resetZoomBtn" class="btn btn-sm btn-outline-secondary">Reset Zoom</button>
                        <button id="toggleChartBtn" class="btn btn-sm btn-success">Show Pie Chart</button>
                      </div>
                    </div>
                    <canvas id="vehicleChart" height="180"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h5 class="card-title mb-0">Results</h5>
                    <ul class="nav nav-tabs border-0" id="vehicleDetailsTabs" role="tablist">
                      <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="vehicle-details-tab" data-bs-toggle="tab" data-bs-target="#vehicle-details-pane" type="button" role="tab" aria-controls="vehicle-details-pane" aria-selected="true">Vehicle Details</button>
                      </li>
                      <li class="nav-item" role="presentation">
                        <button class="nav-link" id="vehicle-search-tab" data-bs-toggle="tab" data-bs-target="#vehicle-search-pane" type="button" role="tab" aria-controls="vehicle-search-pane" aria-selected="false">Search</button>
                      </li>
                    </ul>
                  </div>
                  <div class="vehicle-search-controls d-none align-items-center gap-2" id="vehicleSearchControls">
                    <select class="form-select form-select-sm" id="vehicleSearchField" aria-label="Vehicle search field">
                      <option value="IAA Id" selected>IAA Id</option>
                      <option value="SLK Id">SLK Id</option>
                      <option value="Registration">Registration</option>
                    </select>
                    <input type="text" class="form-control form-control-sm" id="vehicleSearchInput" placeholder="Search" aria-label="Search vehicle details">
                  </div>
                  <small class="text-muted"></small>
                </div>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="vehicle-details-pane" role="tabpanel" aria-labelledby="vehicle-details-tab" tabindex="0">
                    <div class="table-responsive vehicle-table-frame">
                      <table class="table table-striped table-sm align-middle vehicle-details-table" id="vehicleDetailsTable">
                        <thead>
                          <tr>
                            {% for column in detail_columns %}
                              <th>{{ column }}</th>
                            {% endfor %}
                          </tr>
                          <tr class="filter-row">
                            {% for column in detail_columns %}
                              <th>
                                <input
                                  type="text"
                                  class="form-control form-control-sm vehicle-details-filter"
                                  data-column-index="{{ loop.index0 }}"
                                  placeholder="Filter"
                                  aria-label="Filter {{ column }}"
                                >
                              </th>
                            {% endfor %}
                          </tr>
                        </thead>
                        <tbody id="vehicleDetailsTableBody">
                          {% for row in detail_rows %}
                            {% set slk_id_index = detail_columns.index('SLK Id') if 'SLK Id' in detail_columns else 0 %}
                            <tr>
                              {% for value in row %}
                                {% if detail_columns[loop.index0] == 'HasComments' and value == 'YES' %}
                                  <td><button type="button" class="has-comments-btn has-comments-unread" data-vehicle-id="{{ row[slk_id_index] }}">YES</button></td>
                                {% else %}
                                  <td>{{ value }}</td>
                                {% endif %}
                              {% endfor %}
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="tab-pane fade" id="vehicle-search-pane" role="tabpanel" aria-labelledby="vehicle-search-tab" tabindex="0">
                    <div class="table-responsive vehicle-table-frame">
                      <table class="table table-striped table-sm align-middle vehicle-details-table" id="vehicleSearchTable">
                        <thead>
                          <tr>
                            {% for column in detail_columns %}
                              <th>{{ column }}</th>
                            {% endfor %}
                          </tr>
                        </thead>
                        <tbody id="vehicleSearchTableBody">
                          <tr>
                            <td colspan="{{ detail_columns|length }}" class="text-muted">Enter a search value to view results.</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
        <div class="modal fade" id="vehicleNotesModal" tabindex="-1" aria-labelledby="vehicleNotesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="vehicleNotesModalLabel">Vehicle Comments</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input comment-read-scope-toggle" type="checkbox" role="switch" id="commentReadScopeGlobalModal" data-comment-scope-toggle>
              <label class="form-check-label" for="commentReadScopeGlobalModal">Use global read status (shared across all users)</label>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>Id</th>
                    <th>Subject</th>
                    <th>DateCreated</th>
                  </tr>
                </thead>
                <tbody id="vehicleNotesList">
                  <tr><td colspan="3" class="text-muted">Select a vehicle comment to load data.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="noteBodyModal" tabindex="-1" aria-labelledby="noteBodyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="noteBodyModalLabel">Comment Body</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre id="noteBodyContent" class="mb-3" style="white-space: pre-wrap;"></pre>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="noteReadToggle">
              <label class="form-check-label" for="noteReadToggle">
                Mark this comment as read
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const chartLabels = {{ chart_labels|tojson }};
      const chartValues = {{ chart_values|tojson }};
      const totalSumCell = document.getElementById('totalSumCell');
      const dateRangeLabel = document.getElementById('dateRangeLabel');
      const chartTitle = document.getElementById('chartTitle');
      const resetZoomBtn = document.getElementById('resetZoomBtn');
      const toggleChartBtn = document.getElementById('toggleChartBtn');
      const liveCheckbox = document.getElementById('liveToggle');
      const customStartDate = document.getElementById('customStartDate');
      const customEndDate = document.getElementById('customEndDate');
      const dateFieldLabel = document.getElementById('dateFieldLabel');
      const vehicleNotesList = document.getElementById('vehicleNotesList');
      const noteBodyContent = document.getElementById('noteBodyContent');
      const noteReadToggle = document.getElementById('noteReadToggle');
      const commentReadScopeToggles = Array.from(document.querySelectorAll('[data-comment-scope-toggle]'));
      let detailColumnNames = {{ detail_columns|tojson }};
      let currentDetailRows = {{ detail_rows|tojson }};
      let selectedVehicleId = null;
      let selectedNoteId = null;
      let vehicleNotesRequestController = null;
      let isGlobalCommentScopeEnabled = false;

      function getCommentReadScope() {
        return isGlobalCommentScopeEnabled ? 'global' : 'user';
      }

      function syncCommentReadScopeToggles(checked) {
        isGlobalCommentScopeEnabled = Boolean(checked);
        commentReadScopeToggles.forEach((toggle) => {
          toggle.checked = isGlobalCommentScopeEnabled;
        });
      }

      function syncCommentScopeUrlParam() {
        const url = new URL(window.location.href);
        if (getCommentReadScope() === 'global') {
          url.searchParams.set('comment_scope', 'global');
        } else {
          url.searchParams.delete('comment_scope');
        }
        window.history.replaceState({}, '', url);
      }

      function applyCommentScopeToDateControls() {
        const scope = getCommentReadScope();
        document.querySelectorAll('a.date-link, a.date-field-link').forEach((link) => {
          const linkUrl = new URL(link.href, window.location.origin);
          if (scope === 'global') {
            linkUrl.searchParams.set('comment_scope', 'global');
          } else {
            linkUrl.searchParams.delete('comment_scope');
          }
          link.href = linkUrl.toString();
        });

        const customDateForm = document.querySelector('form input[name="filter"][value="custom"]')?.closest('form');
        if (customDateForm) {
          let scopeInput = customDateForm.querySelector('input[name="comment_scope"]');
          if (scope === 'global') {
            if (!scopeInput) {
              scopeInput = document.createElement('input');
              scopeInput.type = 'hidden';
              scopeInput.name = 'comment_scope';
              customDateForm.appendChild(scopeInput);
            }
            scopeInput.value = 'global';
          } else if (scopeInput) {
            scopeInput.remove();
          }
        }
      }


      function fetchWithTimeout(resource, options = {}, timeoutMs = 15000) {
        const controller = new AbortController();
        const timeoutId = window.setTimeout(() => controller.abort(), timeoutMs);
        const signal = options.signal
          ? AbortSignal.any([options.signal, controller.signal])
          : controller.signal;

        return fetch(resource, { ...options, signal })
          .finally(() => window.clearTimeout(timeoutId));
      }
      
      function syncCustomEndDate() {
        if (!customStartDate || !customEndDate) return;
        if (!customEndDate.value && customStartDate.value) {
          customEndDate.value = customStartDate.value;
        }
      }

      if (customStartDate && customEndDate) {
        customStartDate.addEventListener('change', syncCustomEndDate);
        customEndDate.addEventListener('focus', syncCustomEndDate);
      }

      if (commentReadScopeToggles.length) {
        const params = new URLSearchParams(window.location.search);
        syncCommentReadScopeToggles((params.get('comment_scope') || '').toLowerCase() === 'global');
        applyCommentScopeToDateControls();
      }
      const vehicleDetailsTableBody = document.getElementById('vehicleDetailsTableBody');
      const vehicleDetailsTable = document.getElementById('vehicleDetailsTable');
      const vehicleSearchTableBody = document.getElementById('vehicleSearchTableBody');
      const vehicleSearchField = document.getElementById('vehicleSearchField');
      const vehicleSearchInput = document.getElementById('vehicleSearchInput');
      const vehicleSearchButton = document.getElementById('vehicleSearchButton');
      const vehicleSearchControls = document.getElementById('vehicleSearchControls');
      const vehicleSearchTab = document.getElementById('vehicle-search-tab');
      const vehicleDetailsTab = document.getElementById('vehicle-details-tab');
      const detailFilterInputs = Array.from(document.querySelectorAll('.vehicle-details-filter'));
      const chartTitleBase = {{ chart_title_base|tojson }};

      let chartInstance = null;
      let currentChartType = 'bar';
      let labels = chartLabels.slice();
      let values = chartValues.slice();

      function updateHasCommentsButtonState(button, hasUnread) {
        if (!button) return;
        button.classList.remove('has-comments-read', 'has-comments-unread');
        button.classList.add(hasUnread ? 'has-comments-unread' : 'has-comments-read');
      }

      function updateHasCommentsButtonStateByVehicle(vehicleId, hasUnread) {
        document.querySelectorAll(`.has-comments-btn[data-vehicle-id="${String(vehicleId)}"]`).forEach((button) => {
          updateHasCommentsButtonState(button, hasUnread);
        });
      }

      async function refreshHasCommentsButtonStates() {
        const ids = Array.from(document.querySelectorAll('.has-comments-btn[data-vehicle-id]'))
          .map((button) => (button.dataset.vehicleId || '').trim())
          .filter((value) => value);
        const uniqueIds = [...new Set(ids)];
        if (!uniqueIds.length) return;

        const url = new URL('/vehicle_comment_status', window.location.origin);
        url.searchParams.set('scope', getCommentReadScope());
        uniqueIds.forEach((vehicleId) => url.searchParams.append('vehicle_id', vehicleId));
        try {
          const response = await fetch(url.toString(), { cache: 'no-store' });
          if (!response.ok) return;
          const data = await response.json();
          const statuses = data.statuses || {};
          uniqueIds.forEach((vehicleId) => {
            const status = statuses[String(vehicleId)] || {};
            updateHasCommentsButtonStateByVehicle(vehicleId, Boolean(status.has_unread));
          });
        } catch (err) {
          console.error('Unable to refresh comment read statuses', err);
        }
      }

      function generateColors(count) {
        const palette = ['#5c9c13', '#7fbf2e', '#b2d97c', '#2e5e0f', '#3f7f16', '#94c11f'];
        return Array.from({ length: count }, (_, index) => palette[index % palette.length]);
      }

      function buildChartConfig(type) {
        const colors = generateColors(labels.length);
        const isPie = type === 'pie';
        const getChartValue = (context) => {
          if (typeof context.raw === 'number') {
            return context.raw;
          }
          if (typeof context.parsed === 'number') {
            return context.parsed;
          }
          if (context.parsed && typeof context.parsed.y === 'number') {
            return context.parsed.y;
          }
          return 0;
        };
        return {
          type,
          data: {
            labels,
            datasets: [
              {
                label: 'Vehicles',
                data: values,
                backgroundColor: colors,
                borderColor: isPie ? '#fff' : colors,
                borderWidth: isPie ? 1 : 0,
              },
            ],
          },
          options: {
            responsive: true,
            layout: {
              padding: {
                top: isPie ? 0 : 20,
              },
            },
            plugins: {
              legend: {
                display: isPie,
                position: 'bottom',
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.label}: ${getChartValue(context).toLocaleString()}`,
                },
              },
              datalabels: {
                color: '#1f3b08',
                anchor: isPie ? 'end' : 'end',
                align: isPie ? 'end' : 'end',
                formatter: (value) => Number(value).toLocaleString(),
              },
              zoom: {
                zoom: {
                  wheel: { enabled: !isPie },
                  pinch: { enabled: !isPie },
                  mode: 'x',
                },
                pan: {
                  enabled: !isPie,
                  mode: 'x',
                },
              },
            },
            scales: isPie
              ? {}
              : {
                  x: {
                    ticks: {
                      color: '#1f3b08',
                      maxRotation: 45,
                      minRotation: 0,
                    },
                  },
                  y: {
                    ticks: {
                      color: '#1f3b08',
                    },
                    beginAtZero: true,
                  },
                },
          },
          plugins: [ChartDataLabels],
        };
      }

      function renderChart(type) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        chartInstance = new Chart(
          document.getElementById('vehicleChart'),
          buildChartConfig(type)
        );
        chartTitle.textContent = type === 'pie'
          ? `${chartTitleBase} (Pie)`
          : `${chartTitleBase} (Bar)`;
      }

      function updateChartData(data) {
        labels = data.chart_labels;
        values = data.chart_values;
        if (chartInstance) {
          chartInstance.data.labels = labels;
          chartInstance.data.datasets[0].data = values;
          chartInstance.data.datasets[0].backgroundColor = generateColors(labels.length);
          chartInstance.update();
        }
      }

      function rebuildTable(data) {
        const tbody = document.getElementById('companyTableBody');
        tbody.innerHTML = '';
        data.rows.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.label}</td>
            <td class="text-end">${Number(row.total).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });
        totalSumCell.textContent = Number(data.sum_total).toLocaleString();
        dateRangeLabel.textContent = `Showing: ${data.date_range_label}`;
      }

      function rebuildDetailsTable(data) {
        if (!vehicleDetailsTableBody) return;
        vehicleDetailsTableBody.innerHTML = '';
        detailColumnNames = data.detail_columns || detailColumnNames || [];
        const commentsIndex = detailColumnNames.indexOf('HasComments');
        const slkIdIndex = detailColumnNames.indexOf('SLK Id');
        currentDetailRows = data.detail_rows || [];
        const detailRows = currentDetailRows;
        detailRows.forEach((row) => {
          const tr = document.createElement('tr');
          row.forEach((value, index) => {
            const td = document.createElement('td');
            if (index === commentsIndex && value === 'YES') {
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'has-comments-btn has-comments-unread';
              button.dataset.vehicleId = slkIdIndex >= 0 ? row[slkIdIndex] : row[0];
              button.textContent = 'YES';
              td.appendChild(button);
            } else {
              td.textContent = value ?? '';
            }
            tr.appendChild(td);
          });
          vehicleDetailsTableBody.appendChild(tr);
        });
        applyDetailFilters();
        showSearchPlaceholder('Enter a search value and click Search.');
        syncVehicleDetailsStickyOffsets();
        refreshHasCommentsButtonStates();
      }

function renderSearchResults(rows) {
        if (!vehicleSearchTableBody) return;
        vehicleSearchTableBody.innerHTML = '';

        if (!rows.length) {
          vehicleSearchTableBody.innerHTML = `<tr><td colspan="${Math.max(detailColumnNames.length, 1)}" class="text-muted">No records match your search.</td></tr>`;
          return;
        }

        const commentsIndex = detailColumnNames.indexOf('HasComments');
        const slkIdIndex = detailColumnNames.indexOf('SLK Id');

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          row.forEach((value, index) => {
            const td = document.createElement('td');
            if (index === commentsIndex && value === 'YES') {
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'has-comments-btn has-comments-unread';
              button.dataset.vehicleId = slkIdIndex >= 0 ? row[slkIdIndex] : row[0];
              button.textContent = 'YES';
              td.appendChild(button);
            } else {
              td.textContent = value ?? '';
            }
            tr.appendChild(td);
          });
          vehicleSearchTableBody.appendChild(tr);
        });
        refreshHasCommentsButtonStates();
      }

      function showSearchPlaceholder(message) {
        if (!vehicleSearchTableBody) return;
        vehicleSearchTableBody.innerHTML = `<tr><td colspan="${Math.max(detailColumnNames.length, 1)}" class="text-muted">${message}</td></tr>`;
      }

      async function runVehicleSearch() {
        const query = (vehicleSearchInput?.value || '').trim();
        if (!query) {
          showSearchPlaceholder('Enter a search value to view results.');
          return;
        }

        const field = vehicleSearchField?.value || 'IAA Id';
        showSearchPlaceholder('Searching...');

        try {
          const url = new URL("{{ url_for('vehicle_stats_search') }}", window.location.origin);
          url.searchParams.set('field', field);
          url.searchParams.set('q', query);

          const response = await fetch(url.toString(), { cache: 'no-store' });
          if (!response.ok) {
            throw new Error('Unable to search vehicles');
          }

          const data = await response.json();
          if (Array.isArray(data.detail_columns) && data.detail_columns.length) {
            detailColumnNames = data.detail_columns;
          }
          renderSearchResults(Array.isArray(data.detail_rows) ? data.detail_rows : []);
        } catch (err) {
          showSearchPlaceholder(err.message || 'Unable to search vehicles.');
        }
      }

      function applyDetailFilters() {
        if (!vehicleDetailsTableBody) return;
        const activeFilters = detailFilterInputs.map((input) => (input.value || '').trim().toLowerCase());
        Array.from(vehicleDetailsTableBody.querySelectorAll('tr')).forEach((row) => {
          const cells = Array.from(row.children);
          const isMatch = activeFilters.every((filterValue, index) => {
            if (!filterValue) return true;
            const cellValue = (cells[index]?.textContent || '').trim().toLowerCase();
            return cellValue.includes(filterValue);
          });
          row.style.display = isMatch ? '' : 'none';
        });
      }

      function syncVehicleDetailsStickyOffsets() {
        document.querySelectorAll('.vehicle-details-table').forEach((table) => {
          if (!table || !table.style) return;
          const titleRow = table.querySelector('thead tr:first-child');
          if (!titleRow) return;
          const rowHeight = Math.ceil(titleRow.getBoundingClientRect().height || 0);
          if (!Number.isFinite(rowHeight) || rowHeight <= 0) return;
          table.style.setProperty('--vehicle-details-header-row-height', `${rowHeight}px`);
        });
      }

      function formatNoteCellValue(value) {
        return value ?? '';
      }

            function formatVehicleNoteDate(value) {
        if (!value) return '';
        const normalizedValue = String(value).trim();

        const directMatch = normalizedValue.match(
          /^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/
        );
        if (directMatch) {
          const [, year, month, day, hours, minutes, seconds] = directMatch;
          return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
        }

        const parsed = new Date(normalizedValue);
        if (Number.isNaN(parsed.getTime())) return normalizedValue;

        const day = String(parsed.getDate()).padStart(2, '0');
        const month = String(parsed.getMonth() + 1).padStart(2, '0');
        const year = parsed.getFullYear();
        const hours = String(parsed.getHours()).padStart(2, '0');
        const minutes = String(parsed.getMinutes()).padStart(2, '0');
        const seconds = String(parsed.getSeconds()).padStart(2, '0');

        return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
      }

      async function saveNoteReadState(vehicleId, noteId, isRead) {
        if (!vehicleId || !noteId) return;
        try {
          await fetch('/vehicle_note_read_state', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              vehicle_id: Number(vehicleId),
              note_id: Number(noteId),
              is_read: Boolean(isRead),
              scope: getCommentReadScope(),
            }),
          });
        } catch (err) {
          console.error('Unable to save note read state', err);
        }
      }

      function setNoteSubjectReadState(noteId, isRead) {
        const subjectCell = vehicleNotesList.querySelector(`[data-note-subject-id="${String(noteId)}"]`);
        if (!subjectCell) return;
        subjectCell.classList.toggle('vehicle-note-subject-unread', !Boolean(isRead));
      }

      async function loadVehicleNotes(vehicleId) {
        vehicleNotesRequestController?.abort();
        vehicleNotesRequestController = new AbortController();

        selectedVehicleId = vehicleId;
        selectedNoteId = null;
        noteBodyContent.textContent = '';
        if (noteReadToggle) {
          noteReadToggle.checked = false;
          noteReadToggle.disabled = true;
        }

        vehicleNotesList.innerHTML = '<tr><td colspan="3" class="text-muted">Loading comments...</td></tr>';
        bootstrap.Modal.getOrCreateInstance(document.getElementById('vehicleNotesModal')).show();
        try {
          const notesUrl = new URL(`/vehicle_notes/${vehicleId}`, window.location.origin);
          notesUrl.searchParams.set('scope', getCommentReadScope());
          const response = await fetchWithTimeout(
            notesUrl.toString(),
            {
              cache: 'no-store',
              signal: vehicleNotesRequestController.signal,
            },
            15000
          );
          if (!response.ok) throw new Error('Unable to load notes');
          const data = await response.json();
          const notes = data.notes || [];
          if (!notes.length) {
            vehicleNotesList.innerHTML = '<tr><td colspan="3" class="text-muted">No comments found for this vehicle.</td></tr>';
            updateHasCommentsButtonStateByVehicle(vehicleId, false);
            return;
          }
          vehicleNotesList.innerHTML = '';
          notes.forEach((note) => {
            const tr = document.createElement('tr');

            const idTd = document.createElement('td');
            const idButton = document.createElement('button');
            idButton.type = 'button';
            idButton.className = 'note-row-btn btn btn-link btn-sm p-0';
            idButton.dataset.noteId = note.Id;
            idButton.dataset.vehicleId = vehicleId;
            idButton.textContent = formatNoteCellValue(note.Id);
            idTd.appendChild(idButton);
            tr.appendChild(idTd);

            const subjectTd = document.createElement('td');
            subjectTd.dataset.noteSubjectId = String(note.Id);
            subjectTd.textContent = formatNoteCellValue(note.Subject);
            subjectTd.classList.toggle('vehicle-note-subject-unread', !Boolean(note.IsRead));
            tr.appendChild(subjectTd);

            const dateCreatedTd = document.createElement('td');
            dateCreatedTd.textContent = formatVehicleNoteDate(note.DateCreated);
            tr.appendChild(dateCreatedTd);

            vehicleNotesList.appendChild(tr);
          });
          updateHasCommentsButtonStateByVehicle(vehicleId, Boolean(data.has_unread));
        } catch (err) {
          if (err.name === 'AbortError') {
            vehicleNotesList.innerHTML = '<tr><td colspan="3" class="text-warning">Loading comments timed out. Please try again.</td></tr>';
            return;
          }
          vehicleNotesList.innerHTML = `<tr><td colspan="3" class="text-danger">${err.message}</td></tr>`;
        } finally {
          vehicleNotesRequestController = null;
        }
      }

      async function loadNoteBody(noteId, vehicleId) {
        selectedNoteId = noteId;
        selectedVehicleId = vehicleId;
        noteBodyContent.textContent = 'Loading comment body...';
        if (noteReadToggle) {
          noteReadToggle.disabled = true;
        }
        bootstrap.Modal.getOrCreateInstance(document.getElementById('noteBodyModal')).show();
        try {
          const response = await fetch(`/vehicle_note_body/${noteId}`, { cache: 'no-store' });
          if (!response.ok) throw new Error('Unable to load comment body');
          const data = await response.json();
          noteBodyContent.textContent = data.content || '(No body text)';
          if (noteReadToggle) {
            noteReadToggle.checked = true;
            noteReadToggle.disabled = false;
          }
          await saveNoteReadState(vehicleId, noteId, true);
          setNoteSubjectReadState(noteId, true);
          updateHasCommentsButtonStateByVehicle(vehicleId, false);
          await refreshHasCommentsButtonStates();
        } catch (err) {
          noteBodyContent.textContent = err.message;
        }
      }

      function buildDataUrl() {
        const url = new URL("{{ url_for('vehicle_stats_data') }}", window.location.origin);
        const params = new URLSearchParams(window.location.search);
        if (!params.has('filter')) {
          params.set('filter', "{{ filter_type }}");
        }
        params.forEach((value, key) => {
          url.searchParams.append(key, value);
        });
        return url.toString();
      }

      let liveInterval = null;

      async function refreshStats() {
        try {
          const response = await fetch(buildDataUrl(), { cache: 'no-store' });
          if (!response.ok) return;
          const data = await response.json();
          rebuildTable(data);
          updateChartData(data);
          rebuildDetailsTable(data);
          if (dateFieldLabel && data.date_field_label) {
            dateFieldLabel.textContent = `Query Date: ${data.date_field_label}`;
          }
        } catch (err) {
          console.error('Live vehicle stats refresh failed', err);
        }
      }

      function syncLiveParam(checked) {
        const url = new URL(window.location.href);
        if (checked) {
          url.searchParams.set('live', '1');
        } else {
          url.searchParams.delete('live');
        }
        window.history.replaceState({}, '', url);
      }

      function startLiveUpdates() {
        if (liveInterval) return;
        refreshStats();
        liveInterval = setInterval(refreshStats, 5000);
      }

      function stopLiveUpdates() {
        if (liveInterval) {
          clearInterval(liveInterval);
          liveInterval = null;
        }
      }

      function syncLiveControls(enabled) {
        syncLiveParam(enabled);
        document.querySelectorAll('.date-link').forEach((link) => {
          const url = new URL(link.href);
          if (enabled) {
            url.searchParams.set('live', '1');
          } else {
            url.searchParams.delete('live');
          }
          link.href = url.toString();
        });
        document.querySelectorAll('.date-field-link').forEach((link) => {
          const url = new URL(link.href);
          if (enabled) {
            url.searchParams.set('live', '1');
          } else {
            url.searchParams.delete('live');
          }
          link.href = url.toString();
        });
      }

      if (liveCheckbox) {
        liveCheckbox.addEventListener('change', (event) => {
          const enabled = event.target.checked;
          syncLiveControls(enabled);
          if (enabled) {
            startLiveUpdates();
          } else {
            stopLiveUpdates();
          }
        });
      }

        
      renderChart(currentChartType);

      if (vehicleDetailsTable) {
        syncVehicleDetailsStickyOffsets();
        window.addEventListener('resize', syncVehicleDetailsStickyOffsets);
        window.addEventListener('load', syncVehicleDetailsStickyOffsets);
        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(syncVehicleDetailsStickyOffsets);
        }
      }

      if (vehicleDetailsTable && detailFilterInputs.length) {
        detailFilterInputs.forEach((input) => {
          input.addEventListener('input', applyDetailFilters);
        });
        applyDetailFilters();
        syncVehicleDetailsStickyOffsets();
        refreshHasCommentsButtonStates();
      }

      if (vehicleSearchField && vehicleSearchInput) {
        vehicleSearchField.addEventListener('change', () => {
          showSearchPlaceholder('Enter a search value and click Search.');
        });
        vehicleSearchInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            runVehicleSearch();
          }
        });
      }

      if (vehicleSearchButton) {
        vehicleSearchButton.addEventListener('click', runVehicleSearch);
      }

      if (vehicleSearchTab && vehicleSearchControls) {
        vehicleSearchTab.addEventListener('shown.bs.tab', () => {
          vehicleSearchControls.classList.remove('d-none');
          vehicleSearchControls.classList.add('d-flex');
          showSearchPlaceholder('Enter a search value and click Search.');
          syncVehicleDetailsStickyOffsets();
          vehicleSearchInput?.focus();
        });
      }

      if (vehicleDetailsTab && vehicleSearchControls) {
        vehicleDetailsTab.addEventListener('shown.bs.tab', () => {
          vehicleSearchControls.classList.remove('d-flex');
          vehicleSearchControls.classList.add('d-none');
          syncVehicleDetailsStickyOffsets();
        });
      }
      
      if (toggleChartBtn) {
        toggleChartBtn.addEventListener('click', () => {
          currentChartType = currentChartType === 'bar' ? 'pie' : 'bar';
          toggleChartBtn.textContent = currentChartType === 'bar'
            ? 'Show Pie Chart'
            : 'Show Bar Chart';
          renderChart(currentChartType);
        });
      }

      if (resetZoomBtn) {
        resetZoomBtn.addEventListener('click', () => {
          if (chartInstance) {
            chartInstance.resetZoom();
          }
        });
      }



      if (commentReadScopeToggles.length) {
        commentReadScopeToggles.forEach((scopeToggle) => scopeToggle.addEventListener('change', async () => {
          syncCommentReadScopeToggles(scopeToggle.checked);
          syncCommentScopeUrlParam();
          applyCommentScopeToDateControls();
          await refreshHasCommentsButtonStates();
          if (selectedVehicleId) {
            await loadVehicleNotes(selectedVehicleId);
          }
        }));
      }


      if (noteReadToggle) {
        noteReadToggle.addEventListener('change', async () => {
          if (!selectedVehicleId || !selectedNoteId) return;
          await saveNoteReadState(selectedVehicleId, selectedNoteId, noteReadToggle.checked);
          setNoteSubjectReadState(selectedNoteId, noteReadToggle.checked);
          await refreshHasCommentsButtonStates();
        });
      }

      document.addEventListener('click', (event) => {
        const commentsButton = event.target.closest('.has-comments-btn');
        if (commentsButton && commentsButton.dataset.vehicleId) {
          loadVehicleNotes(commentsButton.dataset.vehicleId);
          return;
        }
        const noteButton = event.target.closest('.note-row-btn');
        if (noteButton && noteButton.dataset.noteId) {
          loadNoteBody(noteButton.dataset.noteId, noteButton.dataset.vehicleId || selectedVehicleId);
        }
      });

      const initialLiveEnabled = {{ 'true' if live_enabled else 'false' }};
      if (initialLiveEnabled) {
        syncLiveControls(true);
        startLiveUpdates();
      }

      syncVehicleDetailsStickyOffsets();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
