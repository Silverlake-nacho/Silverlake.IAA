<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Silverlake Vehicle Stats</title>
    <link rel="icon" href="{{ url_for('static', filename='SLK Logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
      :root {
        --sidebar-expanded: 260px;
        --sidebar-collapsed: calc(var(--sidebar-expanded) * 0.3);
        --sidebar-bg: #5c9c13;
      }
      body {
        margin: 0;
        background: url("{{ url_for('static', filename='background.jpg') }}") no-repeat center center fixed;
        background-size: cover;
        font-family: 'Montserrat', sans-serif;
        color: black;
      }
      h1, h2, label {
        color: #5c9c13;
      }
      .page-wrapper {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-collapsed);
        background-color: var(--sidebar-bg);
        color: #fff;
        position: fixed;
        inset: 0 auto 0 0;
        overflow: hidden;
        transition: width 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 12px;
        z-index: 1000;
      }
      .sidebar:hover {
        width: var(--sidebar-expanded);
      }
      .sidebar .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 10px;
      }
      .sidebar .logo-collapsed {
        height: 34px;
        opacity: 1;
        transition: opacity 0.2s ease;
      }
      .sidebar .logo-expanded {
        height: 34px;
        opacity: 0;
        transform: translateX(-6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .sidebar:hover .logo-collapsed {
        opacity: 0;
      }
      .sidebar:hover .logo-expanded {
        opacity: 1;
        transform: translateX(0);
      }
      .sidebar .brand-text {
        font-weight: 700;
        font-size: 1.05rem;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .sidebar:hover .brand-text {
        opacity: 1;
      }
      .sidebar .nav-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .sidebar .nav-link {
        color: #fff;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        text-decoration: none;
        transition: background-color 0.2s ease, color 0.2s ease;
        font-size: 0.95rem;
      }
      .sidebar .nav-link i {
        width: 20px;
        text-align: center;
        font-size: 1.15rem;
      }
      .sidebar .nav-link .link-text {
        white-space: nowrap;
        opacity: 0;
        transform: translateX(-6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .sidebar:hover .nav-link .link-text {
        opacity: 1;
        transform: translateX(0);
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background-color: rgba(255, 255, 255, 0.16);
        color: #fff;
      }
      .sidebar-footer {
        margin-top: auto;
      }
      .content {
        flex: 1;
        margin-left: var(--sidebar-collapsed);
        transition: margin-left 0.3s ease;
      }
      .sidebar:hover ~ .content {
        margin-left: var(--sidebar-expanded);
      }
      .content-inner {
        padding: 24px;
      }
      .logo {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
      }
      .logo img {
        width: 150px;
        max-width: 50%;
        height: auto;
      }
      .summary-card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }

      .mode-toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin-left: 4px;
      }
      .mode-toggle-label {
        color: #5c9c13;
        font-weight: 700;
        margin-bottom: 0;
      }
      .mode-toggle-pill {
        display: inline-flex;
        align-items: center;
        background: #d8f1bb;
        border: 2px solid #5c9c13;
        border-radius: 999px;
        padding: 3px;
      }
      .mode-toggle-option {
        min-width: 132px;
        text-align: center;
        text-decoration: none;
        color: #143800;
        font-weight: 700;
        border-radius: 999px;
        padding: 8px 16px;
        transition: all 0.2s ease;
      }
      .mode-toggle-option:hover {
        color: #143800;
        background: rgba(92, 156, 19, 0.12);
      }
      .mode-toggle-option.active {
        background: #5c9c13;
        color: #fff;
      }
      @media (max-width: 768px) {
        :root {
          --sidebar-expanded: 220px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <nav class="sidebar">
        <div class="brand">
          <img src="{{ url_for('static', filename='SLK Logo.png') }}" alt="Silverlake Collapsed Logo" class="logo-collapsed">
          <img src="{{ url_for('static', filename='logo-slg-strip.svg') }}" alt="Silverlake Logo" class="logo-expanded">
        </div>
        <div class="nav-section">
          <a href="{{ url_for('vehicle_stats') }}" class="nav-link{% if active_page == 'vehicle_stats' %} active{% endif %}">
            <i class="fas fa-car-side"></i>
            <span class="link-text">Vehicle Stats</span>
          </a>
        <div class="sidebar-footer">
          <a href="{{ url_for('logout') }}" class="nav-link">
            <i class="fas fa-arrow-right-from-bracket"></i>
            <span class="link-text">Logout ({{ current_user }})</span>
          </a>
        </div>
      </nav>
      <div class="content">
        <div class="content-inner">
          <div class="container">
            <div class="logo">
              <img src="{{ url_for('static', filename='logo-slg-strip.svg') }}" alt="Silverlake Logo">
            </div>

            <h1 class="mb-4 text-center">Vehicle Stats</h1>

            {% if error_message %}
              <div class="alert alert-danger" role="alert">{{ error_message }}</div>
            {% endif %}

            {% if database_name %}
              <div class="alert alert-info" role="alert">
                Connected to database: <strong>{{ database_name }}</strong>
              </div>
            {% endif %}

            <div class="summary-card">
              <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div class="d-flex flex-wrap align-items-center gap-2">
                      <a href="{{ url_for('vehicle_stats', filter='today', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-primary date-link">Today</a>
                      <a href="{{ url_for('vehicle_stats', filter='yesterday', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-primary date-link">Yesterday</a>
                      <a href="{{ url_for('vehicle_stats', filter='this_week', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-primary date-link">This Week</a>
                      <a href="{{ url_for('vehicle_stats', filter='last_week', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-primary date-link">Last Week</a>
                      <a href="{{ url_for('vehicle_stats', filter='this_month', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-primary date-link">This Month</a>
                      <a href="{{ url_for('vehicle_stats', filter='last_month', group=group_mode, date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-primary date-link">Last Month</a>
                  <form method="get" class="d-inline">
                    <input type="hidden" name="filter" value="custom">
                    <input type="hidden" name="group" value="{{ group_mode }}">
                    <input type="hidden" name="date_field" value="{{ date_field }}">
                    <input type="date" name="start_date" id="customStartDate" required>
                    <input type="date" name="end_date" id="customEndDate" required>
                    {% if live_enabled %}
                      <input type="hidden" name="live" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-sm btn-primary">Custom</button>
                  </form>
                  {% if group_mode == 'branch' %}
                       <a href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group='company', date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-outline-primary">Group by Insurance</a>
                  {% else %}
                       <a href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group='branch', date_field=date_field, live=1 if live_enabled else None) }}" class="btn btn-sm btn-outline-primary">Group by Branch</a>
                  {% endif %}
                  <div class="mode-toggle">
                    <span class="mode-toggle-label">Mode</span>
                    <div class="mode-toggle-pill" role="group" aria-label="Date query mode">
                      <a
                        href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group=group_mode, date_field='recovered', live=1 if live_enabled else None) }}"
                        class="mode-toggle-option date-field-link{% if date_field == 'recovered' %} active{% endif %}"
                      >
                        Date Recovered
                      </a>
                      <a
                        href="{{ url_for('vehicle_stats', filter=filter_type, start_date=start_date.isoformat() if start_date else None, end_date=end_date.isoformat() if end_date else None, group=group_mode, date_field='entered', live=1 if live_enabled else None) }}"
                        class="mode-toggle-option date-field-link{% if date_field == 'entered' %} active{% endif %}"
                      >
                        Date Entered
                      </a>
                    </div>
                  </div>
                </div>
                <div class="form-check ms-2">
                  <input class="form-check-input" type="checkbox" id="liveToggle" {% if live_enabled %}checked{% endif %}>
                  <label class="form-check-label text-success" for="liveToggle">Live</label>
                </div>
              </div>
            </div>

            <div class="row g-4 mb-4">
              <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                  <h5 class="text-success mb-0" id="dateRangeLabel">Showing: {{ date_range_label }}</h5>
                  <span class="badge bg-success" id="dateFieldLabel">Query Date: {{ date_field_label }}</span>
                </div>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>{{ entity_label }}</th>
                      <th class="text-end">Vehicles</th>
                    </tr>
                  </thead>
                  <tbody id="companyTableBody">
                    {% for row in rows %}
                    <tr>
                      <td>{{ row[0] }}</td>
                      <td class="text-end">{{ '{:,.0f}'.format(row[1]) }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr class="fw-bold">
                      <td>Total</td>
                      <td class="text-end" id="totalSumCell">{{ '{:,.0f}'.format(sum_total) }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              <div class="col-lg-6">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="card-title mb-0" id="chartTitle">{{ chart_title_base }} </h5>
                      <div class="d-flex gap-2">
                        <button id="resetZoomBtn" class="btn btn-sm btn-outline-secondary">Reset Zoom</button>
                        <button id="toggleChartBtn" class="btn btn-sm btn-success">Show Pie Chart</button>
                      </div>
                    </div>
                    <canvas id="vehicleChart" height="180"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <h5 class="card-title mb-0">Vehicle Details</h5>
                  <small class="text-muted">Matches the selected date range for cross-referencing counts.</small>
                </div>
                <div class="table-responsive" style="max-height: 60vh;">
                  <table class="table table-striped table-sm align-middle">
                    <thead>
                      <tr>
                        {% for column in detail_columns %}
                          <th>{{ column }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody id="vehicleDetailsTableBody">
                      {% for row in detail_rows %}
                        <tr>
                          {% for value in row %}
                            <td>{{ value }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const chartLabels = {{ chart_labels|tojson }};
      const chartValues = {{ chart_values|tojson }};
      const totalSumCell = document.getElementById('totalSumCell');
      const dateRangeLabel = document.getElementById('dateRangeLabel');
      const chartTitle = document.getElementById('chartTitle');
      const resetZoomBtn = document.getElementById('resetZoomBtn');
      const toggleChartBtn = document.getElementById('toggleChartBtn');
      const liveCheckbox = document.getElementById('liveToggle');
      const customStartDate = document.getElementById('customStartDate');
      const customEndDate = document.getElementById('customEndDate');
      const dateFieldLabel = document.getElementById('dateFieldLabel');

      function syncCustomEndDate() {
        if (!customStartDate || !customEndDate) return;
        if (!customEndDate.value && customStartDate.value) {
          customEndDate.value = customStartDate.value;
        }
      }

      if (customStartDate && customEndDate) {
        customStartDate.addEventListener('change', syncCustomEndDate);
        customEndDate.addEventListener('focus', syncCustomEndDate);
      }
      const vehicleDetailsTableBody = document.getElementById('vehicleDetailsTableBody');
      const chartTitleBase = {{ chart_title_base|tojson }};

      let chartInstance = null;
      let currentChartType = 'bar';
      let labels = chartLabels.slice();
      let values = chartValues.slice();

      function generateColors(count) {
        const palette = ['#5c9c13', '#7fbf2e', '#b2d97c', '#2e5e0f', '#3f7f16', '#94c11f'];
        return Array.from({ length: count }, (_, index) => palette[index % palette.length]);
      }

      function buildChartConfig(type) {
        const colors = generateColors(labels.length);
        const isPie = type === 'pie';
        return {
          type,
          data: {
            labels,
            datasets: [
              {
                label: 'Vehicles',
                data: values,
                backgroundColor: colors,
                borderColor: isPie ? '#fff' : colors,
                borderWidth: isPie ? 1 : 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: isPie,
                position: 'bottom',
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.label}: ${Number(context.parsed).toLocaleString()}`,
                },
              },
              datalabels: {
                color: '#1f3b08',
                anchor: isPie ? 'end' : 'end',
                align: isPie ? 'end' : 'end',
                formatter: (value) => Number(value).toLocaleString(),
              },
              zoom: {
                zoom: {
                  wheel: { enabled: !isPie },
                  pinch: { enabled: !isPie },
                  mode: 'x',
                },
                pan: {
                  enabled: !isPie,
                  mode: 'x',
                },
              },
            },
            scales: isPie
              ? {}
              : {
                  x: {
                    ticks: {
                      color: '#1f3b08',
                      maxRotation: 45,
                      minRotation: 0,
                    },
                  },
                  y: {
                    ticks: {
                      color: '#1f3b08',
                    },
                    beginAtZero: true,
                  },
                },
          },
          plugins: [ChartDataLabels],
        };
      }

      function renderChart(type) {
        if (chartInstance) {
          chartInstance.destroy();
        }
        chartInstance = new Chart(
          document.getElementById('vehicleChart'),
          buildChartConfig(type)
        );
        chartTitle.textContent = type === 'pie'
          ? `${chartTitleBase} (Pie)`
          : `${chartTitleBase} (Bar)`;
      }

      function updateChartData(data) {
        labels = data.chart_labels;
        values = data.chart_values;
        if (chartInstance) {
          chartInstance.data.labels = labels;
          chartInstance.data.datasets[0].data = values;
          chartInstance.data.datasets[0].backgroundColor = generateColors(labels.length);
          chartInstance.update();
        }
      }

      function rebuildTable(data) {
        const tbody = document.getElementById('companyTableBody');
        tbody.innerHTML = '';
        data.rows.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.label}</td>
            <td class="text-end">${Number(row.total).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });
        totalSumCell.textContent = Number(data.sum_total).toLocaleString();
        dateRangeLabel.textContent = `Showing: ${data.date_range_label}`;
      }

      function rebuildDetailsTable(data) {
        if (!vehicleDetailsTableBody) return;
        vehicleDetailsTableBody.innerHTML = '';
        const detailRows = data.detail_rows || [];
        detailRows.forEach((row) => {
          const tr = document.createElement('tr');
          row.forEach((value) => {
            const td = document.createElement('td');
            td.textContent = value ?? '';
            tr.appendChild(td);
          });
          vehicleDetailsTableBody.appendChild(tr);
        });
      }

      function buildDataUrl() {
        const url = new URL("{{ url_for('vehicle_stats_data') }}", window.location.origin);
        const params = new URLSearchParams(window.location.search);
        if (!params.has('filter')) {
          params.set('filter', "{{ filter_type }}");
        }
        params.forEach((value, key) => {
          url.searchParams.append(key, value);
        });
        return url.toString();
      }

      let liveInterval = null;

      async function refreshStats() {
        try {
          const response = await fetch(buildDataUrl(), { cache: 'no-store' });
          if (!response.ok) return;
          const data = await response.json();
          rebuildTable(data);
          updateChartData(data);
          rebuildDetailsTable(data);
          if (dateFieldLabel && data.date_field_label) {
            dateFieldLabel.textContent = `Query Date: ${data.date_field_label}`;
          }
        } catch (err) {
          console.error('Live vehicle stats refresh failed', err);
        }
      }

      function syncLiveParam(checked) {
        const url = new URL(window.location.href);
        if (checked) {
          url.searchParams.set('live', '1');
        } else {
          url.searchParams.delete('live');
        }
        window.history.replaceState({}, '', url);
      }

      function startLiveUpdates() {
        if (liveInterval) return;
        refreshStats();
        liveInterval = setInterval(refreshStats, 5000);
      }

      function stopLiveUpdates() {
        if (liveInterval) {
          clearInterval(liveInterval);
          liveInterval = null;
        }
      }

      function syncLiveControls(enabled) {
        syncLiveParam(enabled);
        document.querySelectorAll('.date-link').forEach((link) => {
          const url = new URL(link.href);
          if (enabled) {
            url.searchParams.set('live', '1');
          } else {
            url.searchParams.delete('live');
          }
          link.href = url.toString();
        });
        document.querySelectorAll('.date-field-link').forEach((link) => {
          const url = new URL(link.href);
          if (enabled) {
            url.searchParams.set('live', '1');
          } else {
            url.searchParams.delete('live');
          }
          link.href = url.toString();
        });
      }

      if (liveCheckbox) {
        liveCheckbox.addEventListener('change', (event) => {
          const enabled = event.target.checked;
          syncLiveControls(enabled);
          if (enabled) {
            startLiveUpdates();
          } else {
            stopLiveUpdates();
          }
        });
      }

      if (toggleChartBtn) {
        toggleChartBtn.addEventListener('click', () => {
          currentChartType = currentChartType === 'bar' ? 'pie' : 'bar';
          toggleChartBtn.textContent = currentChartType === 'bar'
            ? 'Show Pie Chart'
            : 'Show Bar Chart';
          renderChart(currentChartType);
        });
      }

      if (resetZoomBtn) {
        resetZoomBtn.addEventListener('click', () => {
          if (chartInstance) {
            chartInstance.resetZoom();
          }
        });
      }

      const initialLiveEnabled = {{ 'true' if live_enabled else 'false' }};
      if (initialLiveEnabled) {
        syncLiveControls(true);
        startLiveUpdates();
      }

      renderChart(currentChartType);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
